# 第20章：面向对象基础

学习用类和对象组织代码，让程序更模块化、更易维护。

## 什么是面向对象编程？

想象你在玩一个游戏，里面有各种角色：战士、法师、弓箭手。每个角色都有自己的属性（生命值、攻击力）和技能（攻击、防御）。这就是面向对象的思想！

**面向对象编程（OOP）** 是一种编程范式，把相关的数据和功能组织成"对象"。

### 为什么需要面向对象？

```python
# 不使用面向对象 - 数据分散
player1_name = "张三"
player1_hp = 100
player1_attack = 20

player2_name = "李四"
player2_hp = 100
player2_attack = 20

def attack_player(attacker_name, attacker_attack, defender_hp):
    print(f"{attacker_name} 攻击，造成 {attacker_attack} 点伤害")
    defender_hp -= attacker_attack
    return defender_hp

# 使用起来很麻烦
player2_hp = attack_player(player1_name, player1_attack, player2_hp)
```

```python
# 使用面向对象 - 数据和行为封装在一起
class Player:
    def __init__(self, name, hp=100, attack=20):
        self.name = name
        self.hp = hp
        self.attack = attack

    def attack_target(self, target):
        print(f"{self.name} 攻击 {target.name}，造成 {self.attack} 点伤害")
        target.hp -= self.attack

# 使用起来很直观
player1 = Player("张三")
player2 = Player("李四")
player1.attack_target(player2)
```

### 核心概念

- **类（Class）** - 对象的模板/蓝图
- **对象（Object）** - 类的实例
- **属性（Attribute）** - 对象的数据
- **方法（Method）** - 对象的行为/功能

## 定义类

### 基本语法

```python
class ClassName:
    """类的文档字符串"""

    def __init__(self, parameters):
        """构造方法，创建对象时调用"""
        self.attribute = value

    def method(self):
        """实例方法"""
        pass
```

### 简单的例子

```python
class Dog:
    """狗类"""

    def __init__(self, name, age):
        """初始化狗对象"""
        self.name = name
        self.age = age

    def bark(self):
        """叫"""
        print(f"{self.name} 说：汪汪汪！")

    def get_info(self):
        """获取信息"""
        return f"{self.name}，{self.age}岁"

# 创建对象（实例化）
dog1 = Dog("旺财", 3)
dog2 = Dog("小黑", 5)

# 使用对象
print(dog1.name)        # 旺财
dog1.bark()             # 旺财 说：汪汪汪！
print(dog2.get_info())  # 小黑，5岁

# 修改属性
dog1.age = 4
print(dog1.age)  # 4
```

## __init__ 构造方法

`__init__` 是一个特殊方法，在创建对象时自动调用。

### 基本用法

```python
class Person:
    def __init__(self, name, age):
        """初始化人物对象"""
        self.name = name  # 实例属性
        self.age = age
        print(f"创建了一个人物：{name}")

# 创建对象时，__init__被调用
person = Person("张三", 25)  # 打印：创建了一个人物：张三
print(person.name)  # 张三
print(person.age)   # 25
```

### 带默认参数

```python
class Student:
    def __init__(self, name, age=18, grade="一年级"):
        """初始化学生"""
        self.name = name
        self.age = age
        self.grade = grade

# 可以使用默认值
student1 = Student("李四")
print(student1.age)    # 18
print(student1.grade)  # 一年级

# 也可以指定值
student2 = Student("王五", age=20, grade="三年级")
print(student2.age)    # 20
```

### 初始化时的验证

```python
class BankAccount:
    def __init__(self, owner, balance=0):
        """初始化银行账户"""
        self.owner = owner

        # 验证初始余额
        if balance < 0:
            raise ValueError("初始余额不能为负数")
        self.balance = balance

# 正常创建
account1 = BankAccount("张三", 1000)

# 会抛出异常
try:
    account2 = BankAccount("李四", -100)
except ValueError as e:
    print(f"创建失败：{e}")
```

## self 参数

`self` 代表实例本身，是类的方法的第一个参数。

```python
class Counter:
    def __init__(self, start=0):
        self.count = start  # self.count 是实例属性

    def increment(self):
        # 通过 self 访问实例属性
        self.count += 1

    def get_count(self):
        return self.count

counter = Counter(10)
counter.increment()
counter.increment()
print(counter.get_count())  # 12
```

**self 不是关键字**，只是约定俗成的名字，你可以用其他名字：

```python
class Example:
    def __init__(this, value):  # 可以用 this，但不推荐
        this.value = value
```

## 实例属性和方法

### 实例属性

```python
class Car:
    def __init__(self, brand, model, year):
        # 实例属性
        self.brand = brand
        self.model = model
        self.year = year
        self.mileage = 0  # 默认值

car = Car("Toyota", "Camry", 2020)
print(car.brand)   # Toyota
print(car.mileage) # 0

# 可以直接修改属性
car.mileage = 5000
print(car.mileage) # 5000

# 也可以添加新属性（不推荐）
car.color = "red"
print(car.color)   # red
```

### 实例方法

```python
class Calculator:
    def __init__(self):
        self.result = 0

    def add(self, number):
        """加法"""
        self.result += number
        return self.result

    def subtract(self, number):
        """减法"""
        self.result -= number
        return self.result

    def clear(self):
        """清零"""
        self.result = 0

    def get_result(self):
        """获取结果"""
        return self.result

# 使用
calc = Calculator()
calc.add(10)
calc.add(5)
calc.subtract(3)
print(calc.get_result())  # 12
```

## 类属性

类属性是所有实例共享的属性。

```python
class Car:
    # 类属性（所有实例共享）
    wheels = 4
    vehicle_count = 0

    def __init__(self, brand):
        # 实例属性
        self.brand = brand
        # 修改类属性
        Car.vehicle_count += 1

# 访问类属性
print(Car.wheels)  # 4

# 所有实例共享类属性
car1 = Car("Toyota")
car2 = Car("Honda")

print(car1.wheels)  # 4
print(car2.wheels)  # 4
print(Car.vehicle_count)  # 2

# 修改类属性
Car.wheels = 6
print(car1.wheels)  # 6
print(car2.wheels)  # 6
```

### 类属性 vs 实例属性

```python
class Example:
    class_var = "类属性"

    def __init__(self):
        self.instance_var = "实例属性"

obj1 = Example()
obj2 = Example()

# 类属性共享
print(obj1.class_var)  # 类属性
print(obj2.class_var)  # 类属性

# 实例属性独立
obj1.instance_var = "修改了"
print(obj1.instance_var)  # 修改了
print(obj2.instance_var)  # 实例属性（未受影响）

# 注意：给实例属性赋值会创建新的实例属性
obj1.class_var = "实例的class_var"
print(obj1.class_var)  # 实例的class_var（实例属性）
print(obj2.class_var)  # 类属性（类属性未变）
print(Example.class_var)  # 类属性
```

## 类方法和静态方法

### 类方法（@classmethod）

```python
class Person:
    count = 0  # 类属性

    def __init__(self, name):
        self.name = name
        Person.count += 1

    @classmethod
    def get_count(cls):
        """类方法：访问类属性"""
        return cls.count

    @classmethod
    def create_anonymous(cls):
        """类方法：创建匿名对象"""
        return cls("匿名用户")

# 使用类方法
print(Person.get_count())  # 0

person1 = Person("张三")
person2 = Person("李四")

print(Person.get_count())  # 2

# 类方法可以创建对象
anon = Person.create_anonymous()
print(anon.name)  # 匿名用户
```

### 静态方法（@staticmethod）

```python
class MathUtils:
    """数学工具类"""

    @staticmethod
    def add(a, b):
        """静态方法：不访问实例或类"""
        return a + b

    @staticmethod
    def is_even(number):
        """判断是否为偶数"""
        return number % 2 == 0

# 使用静态方法（不需要创建实例）
print(MathUtils.add(10, 20))  # 30
print(MathUtils.is_even(5))   # False

# 也可以通过实例调用
utils = MathUtils()
print(utils.add(5, 3))  # 8
```

## 实战例子

### 例子1：银行账户系统

```python
class BankAccount:
    """银行账户类"""

    # 类属性
    interest_rate = 0.03
    account_count = 0

    def __init__(self, owner, balance=0):
        """初始化账户"""
        self.owner = owner
        self.balance = balance
        self.transactions = []  # 交易记录
        BankAccount.account_count += 1

    def deposit(self, amount):
        """存款"""
        if amount <= 0:
            print("存款金额必须大于0")
            return False

        self.balance += amount
        self.transactions.append(f"存款 +¥{amount}")
        print(f"存款成功：¥{amount}，当前余额：¥{self.balance}")
        return True

    def withdraw(self, amount):
        """取款"""
        if amount <= 0:
            print("取款金额必须大于0")
            return False

        if amount > self.balance:
            print(f"余额不足，当前余额：¥{self.balance}")
            return False

        self.balance -= amount
        self.transactions.append(f"取款 -¥{amount}")
        print(f"取款成功：¥{amount}，当前余额：¥{self.balance}")
        return True

    def transfer(self, target, amount):
        """转账"""
        if self.withdraw(amount):
            target.deposit(amount)
            self.transactions.append(f"转账给 {target.owner} -¥{amount}")
            print(f"转账成功：向 {target.owner} 转账 ¥{amount}")
            return True
        return False

    def add_interest(self):
        """添加利息"""
        interest = self.balance * self.interest_rate
        self.balance += interest
        self.transactions.append(f"利息 +¥{interest:.2f}")
        print(f"利息 ¥{interest:.2f} 已添加")

    def show_transactions(self):
        """显示交易记录"""
        print(f"\n=== {self.owner} 的交易记录 ===")
        if not self.transactions:
            print("暂无交易记录")
        else:
            for i, transaction in enumerate(self.transactions, 1):
                print(f"{i}. {transaction}")
        print(f"当前余额：¥{self.balance}")

    def __str__(self):
        """字符串表示"""
        return f"账户[{self.owner}]: ¥{self.balance}"

# 使用
account1 = BankAccount("张三", 1000)
account2 = BankAccount("李四", 500)

account1.deposit(500)
account1.withdraw(200)
account1.transfer(account2, 300)
account1.add_interest()

account1.show_transactions()
account2.show_transactions()

print(f"\n总账户数：{BankAccount.account_count}")
```

### 例子2：学生成绩管理

```python
class Student:
    """学生类"""

    def __init__(self, name, student_id):
        """初始化学生"""
        self.name = name
        self.student_id = student_id
        self.scores = {}  # {科目: 分数}

    def add_score(self, subject, score):
        """添加成绩"""
        if not 0 <= score <= 100:
            print("分数必须在0-100之间")
            return False

        self.scores[subject] = score
        print(f"已为 {self.name} 添加 {subject} 成绩：{score}分")
        return True

    def get_average(self):
        """计算平均分"""
        if not self.scores:
            return 0
        return sum(self.scores.values()) / len(self.scores)

    def get_total(self):
        """计算总分"""
        return sum(self.scores.values())

    def get_grade(self):
        """获取等级"""
        avg = self.get_average()
        if avg >= 90:
            return "优秀"
        elif avg >= 80:
            return "良好"
        elif avg >= 70:
            return "中等"
        elif avg >= 60:
            return "及格"
        else:
            return "不及格"

    def show_report(self):
        """显示成绩单"""
        print(f"\n{'='*40}")
        print(f"学生：{self.name} ({self.student_id})")
        print(f"{'='*40}")

        if not self.scores:
            print("暂无成绩记录")
            return

        for subject, score in self.scores.items():
            print(f"{subject:8s}: {score}分")

        print(f"{'-'*40}")
        print(f"总分：{self.get_total()}分")
        print(f"平均分：{self.get_average():.1f}分")
        print(f"等级：{self.get_grade()}")
        print(f"{'='*40}")

    def __str__(self):
        """字符串表示"""
        avg = self.get_average()
        return f"{self.name}({self.student_id}) - 平均分：{avg:.1f}"

# 使用
student1 = Student("张三", "2024001")
student1.add_score("语文", 85)
student1.add_score("数学", 92)
student1.add_score("英语", 88)
student1.add_score("物理", 90)

student1.show_report()

student2 = Student("李四", "2024002")
student2.add_score("语文", 78)
student2.add_score("数学", 65)
student2.add_score("英语", 72)

student2.show_report()
```

### 例子3：购物车系统

```python
class Product:
    """商品类"""

    def __init__(self, name, price, stock):
        """初始化商品"""
        self.name = name
        self.price = price
        self.stock = stock

    def __str__(self):
        return f"{self.name} - ¥{self.price} (库存：{self.stock})"

class ShoppingCart:
    """购物车类"""

    def __init__(self, owner):
        """初始化购物车"""
        self.owner = owner
        self.items = []  # [(product, quantity), ...]

    def add_item(self, product, quantity=1):
        """添加商品"""
        if quantity <= 0:
            print("数量必须大于0")
            return False

        if quantity > product.stock:
            print(f"库存不足，{product.name} 仅剩 {product.stock} 件")
            return False

        # 检查是否已存在
        for i, (item, qty) in enumerate(self.items):
            if item.name == product.name:
                # 更新数量
                new_qty = qty + quantity
                if new_qty > product.stock:
                    print(f"超过库存限制")
                    return False
                self.items[i] = (item, new_qty)
                print(f"已更新 {product.name} 数量：{new_qty}")
                return True

        # 添加新商品
        self.items.append((product, quantity))
        print(f"已添加：{product.name} x{quantity}")
        return True

    def remove_item(self, product_name):
        """移除商品"""
        for i, (product, qty) in enumerate(self.items):
            if product.name == product_name:
                self.items.pop(i)
                print(f"已移除：{product_name}")
                return True
        print(f"购物车中没有：{product_name}")
        return False

    def update_quantity(self, product_name, quantity):
        """更新数量"""
        if quantity <= 0:
            return self.remove_item(product_name)

        for i, (product, qty) in enumerate(self.items):
            if product.name == product_name:
                if quantity > product.stock:
                    print(f"库存不足")
                    return False
                self.items[i] = (product, quantity)
                print(f"已更新 {product_name} 数量：{quantity}")
                return True

        print(f"购物车中没有：{product_name}")
        return False

    def get_total(self):
        """计算总价"""
        total = sum(product.price * qty for product, qty in self.items)
        return total

    def show_cart(self):
        """显示购物车"""
        print(f"\n{'='*50}")
        print(f"{self.owner} 的购物车")
        print(f"{'='*50}")

        if not self.items:
            print("购物车为空")
            print(f"{'='*50}")
            return

        for product, qty in self.items:
            subtotal = product.price * qty
            print(f"{product.name:15s} ¥{product.price:6.2f} x{qty:2d} = ¥{subtotal:8.2f}")

        print(f"{'-'*50}")
        print(f"{'总计':>38s} ¥{self.get_total():8.2f}")
        print(f"{'='*50}")

    def checkout(self):
        """结账"""
        if not self.items:
            print("购物车为空")
            return False

        print("\n开始结账...")

        # 检查库存
        for product, qty in self.items:
            if qty > product.stock:
                print(f"{product.name} 库存不足")
                return False

        # 扣除库存
        for product, qty in self.items:
            product.stock -= qty

        total = self.get_total()
        print(f"结账成功！总计：¥{total:.2f}")
        self.items = []  # 清空购物车
        return True

# 使用
# 创建商品
apple = Product("苹果", 5.0, 100)
banana = Product("香蕉", 3.0, 50)
orange = Product("橙子", 4.0, 80)

# 创建购物车
cart = ShoppingCart("张三")

# 添加商品
cart.add_item(apple, 5)
cart.add_item(banana, 3)
cart.add_item(orange, 2)
cart.add_item(apple, 2)  # 再加2个苹果

# 显示购物车
cart.show_cart()

# 更新数量
cart.update_quantity("苹果", 10)
cart.show_cart()

# 结账
cart.checkout()
cart.show_cart()

print(f"\n商品库存更新：")
print(apple)
print(banana)
print(orange)
```

### 例子4：图书管理系统

```python
class Book:
    """图书类"""

    def __init__(self, title, author, isbn, copies=1):
        """初始化图书"""
        self.title = title
        self.author = author
        self.isbn = isbn
        self.total_copies = copies
        self.available_copies = copies

    def borrow(self):
        """借出"""
        if self.available_copies > 0:
            self.available_copies -= 1
            return True
        return False

    def return_book(self):
        """归还"""
        if self.available_copies < self.total_copies:
            self.available_copies += 1
            return True
        return False

    def __str__(self):
        return f"《{self.title}》- {self.author} (ISBN: {self.isbn})"

class Library:
    """图书馆类"""

    def __init__(self, name):
        """初始化图书馆"""
        self.name = name
        self.books = []
        self.borrowed_records = {}  # {用户: [书籍列表]}

    def add_book(self, book):
        """添加图书"""
        self.books.append(book)
        print(f"已添加：{book}")

    def find_book(self, title):
        """查找图书"""
        for book in self.books:
            if book.title == title:
                return book
        return None

    def borrow_book(self, user, title):
        """借书"""
        book = self.find_book(title)

        if not book:
            print(f"图书 《{title}》 不存在")
            return False

        if book.borrow():
            if user not in self.borrowed_records:
                self.borrowed_records[user] = []
            self.borrowed_records[user].append(book)
            print(f"{user} 成功借阅：{book}")
            return True
        else:
            print(f"《{title}》 已全部借出")
            return False

    def return_book(self, user, title):
        """还书"""
        if user not in self.borrowed_records:
            print(f"{user} 没有借阅记录")
            return False

        for i, book in enumerate(self.borrowed_records[user]):
            if book.title == title:
                book.return_book()
                self.borrowed_records[user].pop(i)
                print(f"{user} 成功归还：{book}")
                return True

        print(f"{user} 没有借阅 《{title}》")
        return False

    def show_books(self):
        """显示所有图书"""
        print(f"\n{'='*60}")
        print(f"{self.name} - 藏书列表")
        print(f"{'='*60}")

        if not self.books:
            print("暂无藏书")
        else:
            for book in self.books:
                status = f"{book.available_copies}/{book.total_copies} 可借"
                print(f"{book} - {status}")

        print(f"{'='*60}")

    def show_user_books(self, user):
        """显示用户借阅的书"""
        print(f"\n{user} 的借阅记录：")
        if user not in self.borrowed_records or not self.borrowed_records[user]:
            print("  暂无借阅记录")
        else:
            for book in self.borrowed_records[user]:
                print(f"  - {book}")

# 使用
library = Library("市图书馆")

# 添加图书
library.add_book(Book("Python教程", "张三", "978-1234567890", 3))
library.add_book(Book("算法导论", "李四", "978-0987654321", 2))
library.add_book(Book("设计模式", "王五", "978-1122334455", 1))

# 显示藏书
library.show_books()

# 借书
library.borrow_book("小明", "Python教程")
library.borrow_book("小红", "Python教程")
library.borrow_book("小明", "算法导论")

# 显示借阅记录
library.show_user_books("小明")
library.show_user_books("小红")

# 显示藏书状态
library.show_books()

# 还书
library.return_book("小明", "Python教程")
library.show_books()
```

## 特殊方法（魔术方法）

Python中以双下划线开头和结尾的方法是特殊方法，也叫魔术方法。

### __str__ 和 __repr__

```python
class Point:
    def __init__(self, x, y):
        self.x = x
        self.y = y

    def __str__(self):
        """用户友好的字符串表示（print时调用）"""
        return f"Point({self.x}, {self.y})"

    def __repr__(self):
        """开发者友好的表示（交互式环境）"""
        return f"Point(x={self.x}, y={self.y})"

point = Point(3, 4)
print(point)  # Point(3, 4)  (__str__)
print(repr(point))  # Point(x=3, y=4)  (__repr__)
```

### __len__

```python
class Playlist:
    def __init__(self):
        self.songs = []

    def add_song(self, song):
        self.songs.append(song)

    def __len__(self):
        """len()时调用"""
        return len(self.songs)

playlist = Playlist()
playlist.add_song("歌曲1")
playlist.add_song("歌曲2")
print(len(playlist))  # 2
```

### __eq__ 和比较方法

```python
class Person:
    def __init__(self, name, age):
        self.name = name
        self.age = age

    def __eq__(self, other):
        """== 比较"""
        return self.name == other.name and self.age == other.age

    def __lt__(self, other):
        """< 比较"""
        return self.age < other.age

    def __le__(self, other):
        """<= 比较"""
        return self.age <= other.age

p1 = Person("张三", 25)
p2 = Person("张三", 25)
p3 = Person("李四", 30)

print(p1 == p2)  # True
print(p1 < p3)   # True
print(p1 <= p2)  # True
```

### __getitem__ 和 __setitem__

```python
class MyList:
    def __init__(self):
        self.items = []

    def __getitem__(self, index):
        """获取元素 obj[index]"""
        return self.items[index]

    def __setitem__(self, index, value):
        """设置元素 obj[index] = value"""
        self.items[index] = value

    def append(self, item):
        self.items.append(item)

my_list = MyList()
my_list.append("a")
my_list.append("b")
my_list.append("c")

print(my_list[0])  # a  (__getitem__)
my_list[1] = "B"   # __setitem__
print(my_list[1])  # B
```

### __call__

```python
class Multiplier:
    def __init__(self, factor):
        self.factor = factor

    def __call__(self, value):
        """让对象可以像函数一样调用"""
        return value * self.factor

double = Multiplier(2)
triple = Multiplier(3)

print(double(5))  # 10
print(triple(5))  # 15
```

## 私有属性和方法

以单下划线或双下划线开头的属性/方法表示"私有"（约定）。

```python
class BankAccount:
    def __init__(self, balance):
        self._balance = balance  # 单下划线：约定为私有（但仍可访问）
        self.__pin = "1234"      # 双下划线：名称改编（真正私有）

    def get_balance(self):
        """公开方法访问私有属性"""
        return self._balance

    def _internal_method(self):
        """私有方法（约定）"""
        print("这是内部方法")

    def __verify_pin(self, pin):
        """真正的私有方法"""
        return pin == self.__pin

account = BankAccount(1000)

# 单下划线：可以访问，但不推荐
print(account._balance)  # 1000

# 双下划线：名称被改编，访问不到
# print(account.__pin)  # AttributeError

# 可以通过公开方法访问
print(account.get_balance())  # 1000

# 名称改编后可以访问（不推荐）
print(account._BankAccount__pin)  # 1234
```

## 常见陷阱

### 陷阱1：忘记self

```python
# ❌ 错误
class Example:
    def method():  # 忘记self
        print("Hello")

# obj = Example()
# obj.method()  # TypeError

# ✅ 正确
class Example:
    def method(self):
        print("Hello")
```

### 陷阱2：类属性陷阱

```python
class Example:
    items = []  # 类属性，所有实例共享！

    def add_item(self, item):
        self.items.append(item)

obj1 = Example()
obj2 = Example()

obj1.add_item("A")
obj2.add_item("B")

print(obj1.items)  # ['A', 'B']  # 共享了！
print(obj2.items)  # ['A', 'B']

# ✅ 正确：使用实例属性
class Example:
    def __init__(self):
        self.items = []  # 实例属性，每个实例独立
```

### 陷阱3：修改默认参数

```python
# ❌ 危险
class Example:
    def __init__(self, items=[]):  # 可变默认参数
        self.items = items

obj1 = Example()
obj2 = Example()

obj1.items.append("A")
print(obj2.items)  # ['A']  # 共享了！

# ✅ 正确
class Example:
    def __init__(self, items=None):
        self.items = items if items is not None else []
```

## 练习题

### 练习1：矩形类

创建一个Rectangle类：
- 初始化宽度和高度
- 计算面积和周长
- 实现__str__方法

### 练习2：图书类

创建Book和Library类：
- Book有标题、作者、ISBN
- Library可以添加、删除、搜索图书
- 统计图书数量

### 练习3：扑克牌

创建Card和Deck类：
- Card有花色和点数
- Deck包含52张牌
- 实现洗牌和发牌功能

### 练习4：时间类

创建Time类表示时间：
- 初始化时、分、秒
- 实现时间加减
- 格式化输出

### 练习5：日记本

创建Diary类：
- 添加日记条目（日期+内容）
- 搜索日记
- 显示所有日记

## 下一步

学会了面向对象基础，下一章我们学习面向对象进阶，包括继承、多态等高级特性！

[上一章：第19章 - 异常处理 ←](../19-异常处理/19-异常处理.md)

[下一章：第21章 - 面向对象进阶 →](../21-面向对象进阶/21-面向对象进阶.md)

---

**本章重点**
- ✅ 理解类和对象的概念
- ✅ 掌握__init__构造方法
- ✅ 理解self参数
- ✅ 使用实例属性和方法
- ✅ 理解类属性和类方法
- ✅ 掌握特殊方法
- ✅ 避免常见陷阱

**记住**
- 类是模板，对象是实例
- self代表实例本身
- 实例属性独立，类属性共享
- 特殊方法让类更pythonic
- 避免可变默认参数
- 私有属性以下划线开头
