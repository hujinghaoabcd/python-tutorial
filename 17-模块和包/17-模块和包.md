# 第17章：模块和包

学习如何组织和重用代码，让项目结构更清晰。

## 什么是模块？

想象你写了一个超级好用的计算器函数，每次写新程序都要复制粘贴这些代码？太麻烦了！模块就是用来解决这个问题的。

**模块就是一个.py文件**，里面包含可以重用的代码（函数、类、变量等）。

### 为什么需要模块？

```python
# 不使用模块 - 每个文件都要重复写代码
# file1.py
def calculate_tax(price):
    return price * 0.1

result = calculate_tax(100)

# file2.py
def calculate_tax(price):  # 又写了一遍！
    return price * 0.1

result = calculate_tax(200)
```

```python
# 使用模块 - 代码只写一次，到处使用
# tax_utils.py（模块）
def calculate_tax(price):
    return price * 0.1

# file1.py
import tax_utils
result = tax_utils.calculate_tax(100)

# file2.py
import tax_utils
result = tax_utils.calculate_tax(200)
```

**模块的好处**：
- **代码重用** - 一次编写，到处使用
- **避免重复** - 不用复制粘贴
- **组织代码** - 让项目结构清晰
- **命名空间** - 避免函数名冲突
- **分工合作** - 多人可以分别开发不同模块

## 导入模块的方式

Python提供了多种导入模块的方法。

### 方式1：import 模块名

```python
# 导入整个模块
import math

print(math.pi)        # 3.141592653589793
print(math.sqrt(16))  # 4.0
print(math.pow(2, 3)) # 8.0
```

**特点**：
- 导入整个模块
- 使用时需要加模块名前缀：`模块名.函数名`
- 清晰，不会造成命名冲突

### 方式2：from 模块名 import 函数名

```python
# 只导入需要的函数
from math import pi, sqrt, pow

print(pi)        # 3.141592653589793
print(sqrt(16))  # 4.0
print(pow(2, 3)) # 8.0
# 不需要 math. 前缀
```

**特点**：
- 只导入需要的内容
- 使用时不需要模块名前缀
- 代码更简洁

### 方式3：from 模块名 import *

```python
# 导入模块中的所有内容
from math import *

print(pi)        # 3.141592653589793
print(sqrt(16))  # 4.0
print(sin(0))    # 0.0
```

**注意**：
- ⚠️ **不推荐使用**
- 会导入所有内容，可能造成命名冲突
- 代码可读性差，不知道哪些函数来自哪个模块

```python
# 错误示例 - 命名冲突
from math import *
from statistics import *

# mean() 函数在两个模块中都有，会被覆盖
print(mean([1, 2, 3]))  # 来自哪个模块？不清楚！
```

### 方式4：使用别名（as）

```python
# 给模块起别名
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

# 使用别名
arr = np.array([1, 2, 3])
df = pd.DataFrame({"col": [1, 2, 3]})
plt.plot([1, 2, 3])
```

**常见的别名约定**：
- `numpy` → `np`
- `pandas` → `pd`
- `matplotlib.pyplot` → `plt`
- `seaborn` → `sns`

```python
# 给函数起别名
from math import sqrt as square_root

print(square_root(16))  # 4.0
```

### 导入子模块

```python
# 导入子模块
from os import path

print(path.exists("test.txt"))
print(path.join("folder", "file.txt"))

# 或者
import os.path

print(os.path.exists("test.txt"))
```

## 创建自己的模块

创建模块非常简单，只需要创建一个.py文件！

### 例子1：简单的数学工具模块

```python
# mymath.py
"""
我的数学工具模块
包含常用的数学函数
"""

def add(a, b):
    """两数相加"""
    return a + b

def subtract(a, b):
    """两数相减"""
    return a - b

def multiply(a, b):
    """两数相乘"""
    return a * b

def divide(a, b):
    """两数相除"""
    if b == 0:
        return "错误：除数不能为0"
    return a / b

# 模块常量
PI = 3.14159
E = 2.71828
```

**使用模块**：

```python
# main.py
import mymath

print(mymath.add(10, 5))      # 15
print(mymath.multiply(3, 4))  # 12
print(mymath.PI)              # 3.14159

# 或者
from mymath import add, PI

print(add(10, 5))  # 15
print(PI)          # 3.14159
```

### 例子2：学生管理模块

```python
# student_manager.py
"""学生管理工具模块"""

students = []  # 模块级变量

def add_student(name, age):
    """添加学生"""
    student = {"name": name, "age": age, "scores": []}
    students.append(student)
    print(f"已添加学生：{name}")

def find_student(name):
    """查找学生"""
    for student in students:
        if student["name"] == name:
            return student
    return None

def add_score(name, score):
    """添加成绩"""
    student = find_student(name)
    if student:
        student["scores"].append(score)
        print(f"已为 {name} 添加成绩：{score}")
    else:
        print(f"找不到学生：{name}")

def get_average(name):
    """获取平均分"""
    student = find_student(name)
    if student and student["scores"]:
        avg = sum(student["scores"]) / len(student["scores"])
        return avg
    return 0
```

**使用模块**：

```python
# main.py
import student_manager

student_manager.add_student("张三", 18)
student_manager.add_student("李四", 19)

student_manager.add_score("张三", 85)
student_manager.add_score("张三", 92)
student_manager.add_score("李四", 78)

print(f"张三平均分：{student_manager.get_average('张三')}")
# 张三平均分：88.5
```

### 例子3：文件工具模块

```python
# file_utils.py
"""文件操作工具模块"""

import os

def read_file(filename):
    """读取文件内容"""
    try:
        with open(filename, "r", encoding="utf-8") as f:
            return f.read()
    except FileNotFoundError:
        return f"文件不存在：{filename}"

def write_file(filename, content):
    """写入文件"""
    with open(filename, "w", encoding="utf-8") as f:
        f.write(content)
    print(f"已写入文件：{filename}")

def append_file(filename, content):
    """追加到文件"""
    with open(filename, "a", encoding="utf-8") as f:
        f.write(content + "\n")

def get_file_size(filename):
    """获取文件大小（字节）"""
    if os.path.exists(filename):
        return os.path.getsize(filename)
    return 0

def list_files(directory="."):
    """列出目录中的所有文件"""
    return [f for f in os.listdir(directory) if os.path.isfile(f)]
```

## __name__ == "__main__"

这是Python中一个非常重要的概念！

### 什么是__name__？

`__name__` 是Python的一个内置变量，表示当前模块的名字。

```python
# test.py
print(__name__)

# 直接运行 test.py
# 输出：__main__

# 作为模块导入
# import test
# 输出：test
```

### 为什么需要这个？

```python
# calculator.py
def add(a, b):
    return a + b

def multiply(a, b):
    return a * b

# 测试代码
print("测试加法：", add(3, 5))
print("测试乘法：", multiply(3, 5))
```

**问题**：当别人导入这个模块时，测试代码也会执行！

```python
# main.py
import calculator  # 导入时就会打印测试结果，不好！
```

**解决方法**：

```python
# calculator.py
def add(a, b):
    return a + b

def multiply(a, b):
    return a * b

# 只在直接运行时执行测试
if __name__ == "__main__":
    print("测试加法：", add(3, 5))
    print("测试乘法：", multiply(3, 5))
```

现在：
- 直接运行 `python calculator.py` - 会执行测试代码
- 导入模块 `import calculator` - 不会执行测试代码

### 实战例子

```python
# mylib.py
def process_data(data):
    """处理数据"""
    return [x * 2 for x in data]

def main():
    """主函数 - 用于测试"""
    test_data = [1, 2, 3, 4, 5]
    result = process_data(test_data)
    print(f"测试结果：{result}")

# 只在直接运行时执行主函数
if __name__ == "__main__":
    main()
```

## 模块的搜索路径

Python如何找到模块的？

### 搜索顺序

1. **当前目录** - 先在当前目录找
2. **PYTHONPATH** - 环境变量指定的目录
3. **标准库** - Python安装目录
4. **site-packages** - 第三方包安装目录

```python
import sys

# 查看模块搜索路径
for path in sys.path:
    print(path)
```

### 添加搜索路径

```python
import sys

# 临时添加路径
sys.path.append("/my/custom/path")

# 现在可以导入该路径下的模块
import my_custom_module
```

### 目录结构示例

```
project/
├── main.py
├── utils/
│   └── helper.py
└── libs/
    └── tools.py
```

```python
# main.py
import sys
sys.path.append("utils")
sys.path.append("libs")

import helper
import tools
```

**更好的方法**：使用相对导入或包结构（下文会讲）

## 常用内置模块

Python自带了很多实用模块。

### math - 数学函数

```python
import math

# 取整
print(math.ceil(3.2))   # 4 向上取整
print(math.floor(3.8))  # 3 向下取整
print(math.trunc(3.8))  # 3 截断小数

# 幂和根
print(math.sqrt(16))    # 4.0 平方根
print(math.pow(2, 3))   # 8.0 幂运算

# 阶乘和最大公约数
print(math.factorial(5))  # 120
print(math.gcd(12, 18))   # 6

# 三角函数
print(math.sin(math.pi / 2))  # 1.0
print(math.cos(0))            # 1.0

# 对数
print(math.log(10))      # 2.302... 自然对数
print(math.log10(100))   # 2.0 以10为底
```

### random - 随机数

```python
import random

# 随机整数
print(random.randint(1, 10))        # 1到10的随机整数
print(random.randrange(0, 10, 2))   # 0,2,4,6,8中随机选一个

# 随机浮点数
print(random.random())              # 0到1之间
print(random.uniform(1.5, 5.5))     # 1.5到5.5之间

# 随机选择
colors = ["red", "blue", "green", "yellow"]
print(random.choice(colors))        # 随机选一个

# 随机抽样（不重复）
print(random.sample(colors, 2))     # 随机选2个

# 随机抽样（可重复）
print(random.choices(colors, k=3))  # 随机选3个（可能重复）

# 打乱列表
numbers = [1, 2, 3, 4, 5]
random.shuffle(numbers)
print(numbers)  # [3, 1, 5, 2, 4]（顺序随机）
```

### datetime - 日期时间

```python
from datetime import datetime, timedelta, date, time

# 当前日期时间
now = datetime.now()
print(now)  # 2024-01-15 14:30:45.123456

# 只要日期或时间
today = date.today()
print(today)  # 2024-01-15

current_time = datetime.now().time()
print(current_time)  # 14:30:45.123456

# 创建日期时间
birthday = datetime(2000, 5, 20, 10, 30)
print(birthday)  # 2000-05-20 10:30:00

# 格式化输出
print(now.strftime("%Y-%m-%d"))           # 2024-01-15
print(now.strftime("%Y年%m月%d日"))        # 2024年01月15日
print(now.strftime("%H:%M:%S"))           # 14:30:45
print(now.strftime("%Y-%m-%d %H:%M:%S"))  # 2024-01-15 14:30:45

# 日期计算
tomorrow = now + timedelta(days=1)
next_week = now + timedelta(weeks=1)
yesterday = now - timedelta(days=1)

print(f"明天：{tomorrow.strftime('%Y-%m-%d')}")
print(f"下周：{next_week.strftime('%Y-%m-%d')}")

# 时间差
birthday = datetime(2000, 5, 20)
age_days = (datetime.now() - birthday).days
age_years = age_days // 365
print(f"距离出生已经 {age_days} 天，约 {age_years} 年")
```

### os - 操作系统接口

```python
import os

# 当前目录
print(os.getcwd())  # 获取当前工作目录

# 列出文件
print(os.listdir("."))        # 当前目录的所有文件
print(os.listdir("C:/Users"))  # 指定目录

# 创建/删除目录
os.mkdir("test_dir")              # 创建目录
os.makedirs("a/b/c", exist_ok=True)  # 创建多级目录
os.rmdir("test_dir")              # 删除空目录

# 路径操作
path = os.path.join("folder", "subfolder", "file.txt")
print(path)  # folder/subfolder/file.txt（根据系统自动调整斜杠）

print(os.path.exists("test.txt"))  # 检查是否存在
print(os.path.isfile("test.txt"))  # 是文件吗
print(os.path.isdir("folder"))     # 是目录吗

# 获取文件信息
print(os.path.getsize("test.txt"))  # 文件大小（字节）
print(os.path.getmtime("test.txt")) # 修改时间

# 路径分割
full_path = "/home/user/documents/file.txt"
print(os.path.dirname(full_path))   # /home/user/documents
print(os.path.basename(full_path))  # file.txt
print(os.path.split(full_path))     # ('/home/user/documents', 'file.txt')

# 环境变量
print(os.environ.get("PATH"))
print(os.environ.get("HOME"))
```

### sys - 系统相关

```python
import sys

# Python版本
print(sys.version)        # 详细版本
print(sys.version_info)   # 版本元组

# 命令行参数
print(sys.argv)  # ['script.py', 'arg1', 'arg2']

# 模块搜索路径
print(sys.path)

# 退出程序
# sys.exit()      # 退出
# sys.exit(1)     # 退出并返回错误码

# 标准输入输出
sys.stdout.write("Hello\n")  # 输出到标准输出
# line = sys.stdin.readline()  # 从标准输入读取
```

## 包（Package）

当项目变大时，单个模块不够用了，需要把多个模块组织成包。

### 什么是包？

**包就是一个包含多个模块的文件夹，文件夹里必须有一个 `__init__.py` 文件。**

### 创建包

```
mypackage/
├── __init__.py
├── math_utils.py
├── string_utils.py
└── file_utils.py
```

```python
# mypackage/math_utils.py
def add(a, b):
    return a + b

def multiply(a, b):
    return a * b
```

```python
# mypackage/string_utils.py
def reverse(text):
    return text[::-1]

def capitalize_words(text):
    return text.title()
```

```python
# mypackage/__init__.py
# 可以为空，或者导入常用的函数
from .math_utils import add, multiply
from .string_utils import reverse

# 这样用户就可以直接 from mypackage import add
```

### 使用包

```python
# 方式1：导入整个模块
from mypackage import math_utils
print(math_utils.add(3, 5))

# 方式2：导入特定函数
from mypackage.math_utils import add
print(add(3, 5))

# 方式3：如果__init__.py中已导入
from mypackage import add
print(add(3, 5))
```

### 子包

包可以嵌套：

```
myproject/
├── __init__.py
├── utils/
│   ├── __init__.py
│   ├── math.py
│   └── string.py
└── core/
    ├── __init__.py
    ├── engine.py
    └── config.py
```

```python
# 使用子包
from myproject.utils.math import add
from myproject.core.engine import run

# 或者
from myproject.utils import math
result = math.add(1, 2)
```

### 相对导入

在包内部，模块之间可以使用相对导入：

```python
# mypackage/string_utils.py
from .math_utils import add  # 从同一包导入

# mypackage/subpackage/module.py
from ..math_utils import add  # 从父包导入
from . import other_module    # 从当前包导入
```

## 实战例子

### 例子1：创建工具包

```
mytools/
├── __init__.py
├── calculator.py
├── formatter.py
└── validator.py
```

```python
# mytools/calculator.py
def calculate_tax(price, rate=0.1):
    """计算税费"""
    return price * rate

def calculate_discount(price, discount_percent):
    """计算折扣"""
    return price * (1 - discount_percent / 100)

def calculate_total(items):
    """计算总价"""
    return sum(item["price"] * item["quantity"] for item in items)
```

```python
# mytools/formatter.py
def format_currency(amount):
    """格式化货币"""
    return f"¥{amount:.2f}"

def format_phone(phone):
    """格式化手机号"""
    return f"{phone[:3]} {phone[3:7]} {phone[7:]}"

def format_date(date_str):
    """格式化日期"""
    from datetime import datetime
    dt = datetime.strptime(date_str, "%Y%m%d")
    return dt.strftime("%Y年%m月%d日")
```

```python
# mytools/validator.py
def validate_email(email):
    """验证邮箱"""
    return "@" in email and "." in email

def validate_phone(phone):
    """验证手机号"""
    return len(phone) == 11 and phone.isdigit()

def validate_id_card(id_card):
    """验证身份证号"""
    return len(id_card) in [15, 18]
```

```python
# mytools/__init__.py
"""我的工具包"""

from .calculator import calculate_tax, calculate_discount, calculate_total
from .formatter import format_currency, format_phone, format_date
from .validator import validate_email, validate_phone

__version__ = "1.0.0"
__author__ = "Your Name"

# 用户可以直接：from mytools import calculate_tax
```

**使用工具包**：

```python
from mytools import calculate_tax, format_currency, validate_email

# 计算税费
price = 100
tax = calculate_tax(price)
print(format_currency(price + tax))  # ¥110.00

# 验证邮箱
email = "user@example.com"
if validate_email(email):
    print("邮箱格式正确")
```

### 例子2：数据处理包

```
data_processor/
├── __init__.py
├── cleaner.py
├── analyzer.py
└── exporter.py
```

```python
# data_processor/cleaner.py
def remove_duplicates(data):
    """去重"""
    return list(set(data))

def remove_empty(data):
    """去除空值"""
    return [x for x in data if x]

def normalize_text(text):
    """标准化文本"""
    return text.strip().lower()
```

```python
# data_processor/analyzer.py
def get_statistics(numbers):
    """获取统计信息"""
    return {
        "count": len(numbers),
        "sum": sum(numbers),
        "average": sum(numbers) / len(numbers) if numbers else 0,
        "max": max(numbers) if numbers else None,
        "min": min(numbers) if numbers else None
    }

def count_frequency(items):
    """统计频率"""
    freq = {}
    for item in items:
        freq[item] = freq.get(item, 0) + 1
    return freq
```

## 第三方包

Python的强大之处在于丰富的第三方包！

### 使用pip安装包

```bash
# 安装单个包
pip install requests

# 安装多个包
pip install numpy pandas matplotlib

# 安装指定版本
pip install requests==2.28.0

# 升级包
pip install --upgrade requests

# 卸载包
pip uninstall requests

# 查看已安装的包
pip list

# 查看包信息
pip show requests
```

### 常用第三方包

```python
# requests - HTTP库
import requests
response = requests.get("https://api.github.com")
print(response.json())

# pandas - 数据分析
import pandas as pd
df = pd.DataFrame({"name": ["张三", "李四"], "age": [25, 30]})
print(df)

# numpy - 数值计算
import numpy as np
arr = np.array([1, 2, 3, 4, 5])
print(arr.mean())

# matplotlib - 数据可视化
import matplotlib.pyplot as plt
plt.plot([1, 2, 3, 4])
plt.show()
```

### requirements.txt

管理项目依赖：

```bash
# 生成依赖文件
pip freeze > requirements.txt

# 安装依赖
pip install -r requirements.txt
```

```
# requirements.txt
requests==2.28.0
pandas==1.5.0
numpy==1.23.0
```

## 虚拟环境

每个项目使用独立的Python环境，避免包冲突。

### 创建虚拟环境

```bash
# 创建虚拟环境
python -m venv myenv

# 激活虚拟环境
# Windows:
myenv\Scripts\activate

# Mac/Linux:
source myenv/bin/activate

# 退出虚拟环境
deactivate
```

### 为什么需要虚拟环境？

```
项目A需要 Django 3.0
项目B需要 Django 4.0
→ 不同项目需要不同版本的包
→ 使用虚拟环境隔离每个项目的依赖
```

## 常见陷阱

### 陷阱1：循环导入

```python
# module_a.py
from module_b import func_b

def func_a():
    return func_b()

# module_b.py
from module_a import func_a  # 循环导入！

def func_b():
    return func_a()
```

**解决方法**：
- 重新设计模块结构
- 使用延迟导入（在函数内部导入）

### 陷阱2：修改模块后不生效

```python
import mymodule

# 修改了 mymodule.py，但重新运行还是旧代码？
# 原因：模块已被缓存

# 解决方法：重新加载模块
import importlib
importlib.reload(mymodule)
```

### 陷阱3：__init__.py的作用

```python
# 没有__init__.py，Python 3.3+也能导入
# 但最好还是加上，原因：
# 1. 明确这是一个包
# 2. 可以初始化包
# 3. 控制from package import *的行为
```

### 陷阱4：相对导入在脚本中不能用

```python
# mypackage/module.py
from . import other_module  # 相对导入

# 直接运行会出错
# python mypackage/module.py  # 错误！

# 应该作为包运行
# python -m mypackage.module  # 正确
```

## 最佳实践

### 1. 模块命名规范

```python
# ✅ 好的命名
math_utils.py
string_helper.py
data_processor.py

# ❌ 不好的命名
MyModule.py     # 不要用大写
my-module.py    # 不要用连字符
123module.py    # 不要以数字开头
```

### 2. 模块文档

```python
# mymodule.py
"""
这是模块的文档字符串
说明模块的用途、功能等

作者：Your Name
日期：2024-01-15
"""

def my_function():
    """函数的文档字符串"""
    pass
```

### 3. 限制导出的内容

```python
# mymodule.py
def public_function():
    """公开函数"""
    pass

def _private_function():
    """私有函数（以_开头）"""
    pass

# 控制 from mymodule import * 的行为
__all__ = ["public_function"]  # 只导出这些
```

### 4. 组织大型项目

```
project/
├── src/
│   ├── __init__.py
│   ├── core/
│   ├── utils/
│   └── models/
├── tests/
├── docs/
├── requirements.txt
└── README.md
```

## 练习题

### 练习1：创建计算器模块

创建一个 `calculator.py` 模块，包含加减乘除四个函数，并用 `__name__ == "__main__"` 添加测试代码。

### 练习2：日期工具包

创建一个日期工具包，包含：
- 计算年龄
- 计算两个日期的天数差
- 判断是否为闰年
- 获取某个月有多少天

### 练习3：文件管理模块

创建一个文件管理模块，功能包括：
- 统计文件夹中的文件数量
- 按扩展名分类文件
- 计算文件夹总大小
- 查找特定类型的文件

### 练习4：创建工具包

创建一个包含多个模块的工具包：
```
myutils/
├── __init__.py
├── text.py       # 文本处理
├── number.py     # 数字处理
└── converter.py  # 转换工具
```

### 练习5：随机密码生成器

创建一个模块，生成随机密码：
- 可指定密码长度
- 可选择包含数字、字母、特殊字符
- 保证密码强度

## 下一步

学会了模块和包，下一章我们学习文件读写，处理各种文件！

[上一章：第16章 - Lambda和高阶函数 ←](../16-Lambda和高阶函数/16-Lambda和高阶函数.md)

[下一章：第18章 - 文件读写 →](../18-文件读写/18-文件读写.md)

---

**本章重点**
- ✅ 理解模块和包的概念
- ✅ 掌握导入模块的各种方式
- ✅ 创建自己的模块和包
- ✅ 使用常用内置模块
- ✅ 理解 `__name__ == "__main__"`
- ✅ 使用pip管理第三方包
- ✅ 避免常见陷阱

**记住**
- 模块是代码重用的基础
- 包是组织模块的方式
- `__init__.py` 标识一个包
- 虚拟环境隔离项目依赖
- 优先使用标准库，再考虑第三方包
